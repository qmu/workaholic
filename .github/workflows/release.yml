name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          # Extract version from tag (remove 'v' prefix)
          version="${GITHUB_REF#refs/tags/v}"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Version: $version"

      - name: Find merged PR
        id: pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the commit that this tag points to
          tag_commit=$(git rev-list -n 1 $GITHUB_REF)
          echo "Tag commit: $tag_commit"

          # Find the PR that was merged with this commit
          # Search for PRs merged around this commit
          pr_number=$(gh pr list --state merged --limit 20 --json number,mergeCommit \
            --jq ".[] | select(.mergeCommit.oid == \"$tag_commit\") | .number" || echo "")

          if [ -z "$pr_number" ]; then
            # Try to find PR from the previous commit (tag might be on merge commit)
            parent_commit=$(git rev-parse $tag_commit^)
            pr_number=$(gh pr list --state merged --limit 20 --json number,mergeCommit \
              --jq ".[] | select(.mergeCommit.oid == \"$parent_commit\") | .number" || echo "")
          fi

          if [ -n "$pr_number" ]; then
            echo "Found PR: #$pr_number"
            echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
            echo "pr_url=https://github.com/${{ github.repository }}/pull/$pr_number" >> $GITHUB_OUTPUT
          else
            echo "No PR found for this release"
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "pr_url=" >> $GITHUB_OUTPUT
          fi

      - name: Extract release notes from CHANGELOG
        id: notes
        run: |
          version="${{ steps.version.outputs.version }}"

          # Try to extract section for this version from CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            # Look for version header (## v1.0.26 or ## 1.0.26)
            notes=$(sed -n "/^## .*${version}/,/^## /p" CHANGELOG.md | sed '1d;$d' | head -50)

            if [ -z "$notes" ]; then
              # Fallback: get the first unreleased section
              notes=$(sed -n '/^## /,/^## /p' CHANGELOG.md | sed '1d;$d' | head -50)
            fi
          fi

          # If no CHANGELOG content, use commit messages
          if [ -z "$notes" ]; then
            prev_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -n "$prev_tag" ]; then
              notes=$(git log --pretty=format:"- %s" "$prev_tag"..HEAD --no-merges | head -30)
            else
              notes=$(git log --pretty=format:"- %s" -20 --no-merges)
            fi
          fi

          # Add PR link if available
          if [ -n "${{ steps.pr.outputs.pr_url }}" ]; then
            notes="PR: ${{ steps.pr.outputs.pr_url }}

$notes"
          fi

          # Write to file for multi-line content
          echo "$notes" > /tmp/release_notes.txt
          echo "Release notes:"
          cat /tmp/release_notes.txt

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --notes-file /tmp/release_notes.txt \
            --latest
