---
created_at: 2026-02-07T11:20:21+09:00
author: a@qmu.jp
type: bugfix
layer: [Config]
effort: 0.25h
commit_hash: e7efc31
category: Changed
---

# Fix Mermaid Unquoted Node Labels in Spec Files

## Overview

Multiple spec files in `.workaholic/specs/` contain Mermaid diagrams with unquoted node labels that include `/`, causing GitHub to fail rendering with "Lexical error... Unrecognized text." The `diagrams.md` rule (lines 35-48) already documents that labels containing `/` must be quoted, but analyst subagents generating these specs do not receive this guidance through the `analyze-viewpoint` skill they preload. This ticket fixes both the immediate rendering errors and the root cause that allows them to recur.

## Key Files

- `.workaholic/specs/model.md` - Lines 62-64: `Drive[/drive]`, `Scan[/scan]`, `Report[/report]`
- `.workaholic/specs/model_ja.md` - Lines 62-64: same pattern
- `.workaholic/specs/component.md` - Lines 104-107: `ticket[/ticket]`, `drive[/drive]`, `scan[/scan]`, `report[/report]`
- `.workaholic/specs/component_ja.md` - Lines 71-74: same pattern
- `.workaholic/specs/data_ja.md` - Line 76: `Implement[/drive で実装]`
- `plugins/core/skills/analyze-viewpoint/SKILL.md` - Missing Mermaid quoting reminder
- `plugins/core/rules/diagrams.md` - Existing rule (lines 35-48) that should be reinforced

## Related History

This is the fourth recurrence of the same Mermaid slash-quoting bug. Previous fixes targeted individual files but never addressed the systemic cause: analyst subagents that generate spec documents do not have the quoting rule reinforced in their preloaded skills.

Past tickets that touched similar areas:

- [20260129024255-fix-mermaid-diagram-in-workflow-ja.md](.workaholic/tickets/archive/feat-20260129-023941/20260129024255-fix-mermaid-diagram-in-workflow-ja.md) - Fixed Mermaid slash escaping in workflow guides, added Node Labels section to diagrams rule
- [20260131150915-fix-mermaid-slash-in-labels.md](.workaholic/tickets/archive/feat-20260131-125844/20260131150915-fix-mermaid-slash-in-labels.md) - Fixed slash quoting in architecture.md dependency graph
- [20260131195630-fix-mermaid-slash-quoting-architecture.md](.workaholic/tickets/archive/feat-20260131-125844/20260131195630-fix-mermaid-slash-quoting-architecture.md) - Fixed another unquoted `/story command` label in architecture.md
- [20260124120158-enforce-mermaid-for-diagrams.md](.workaholic/tickets/archive/feat-20260124-105903/20260124120158-enforce-mermaid-for-diagrams.md) - Established Mermaid as the standard for all diagrams

## Implementation Steps

1. **Fix `.workaholic/specs/model.md`** (lines 62-64): Quote the three node labels containing `/`:
   - `Drive[/drive]` to `Drive["/drive"]`
   - `Scan[/scan]` to `Scan["/scan"]`
   - `Report[/report]` to `Report["/report"]`

2. **Fix `.workaholic/specs/model_ja.md`** (lines 62-64): Apply identical changes.

3. **Fix `.workaholic/specs/component.md`** (lines 104-107): Quote the four node labels containing `/`:
   - `ticket[/ticket]` to `ticket["/ticket"]`
   - `drive[/drive]` to `drive["/drive"]`
   - `scan[/scan]` to `scan["/scan"]`
   - `report[/report]` to `report["/report"]`

4. **Fix `.workaholic/specs/component_ja.md`** (lines 71-74): Apply identical changes.

5. **Fix `.workaholic/specs/data_ja.md`** (line 76): Quote the label containing `/`:
   - `Implement[/drive で実装]` to `Implement["/drive で実装"]`

6. **Add Mermaid quoting reminder to `plugins/core/skills/analyze-viewpoint/SKILL.md`**: Add a new section after the "Diagram" section in the Output Template (after line 66) reinforcing the quoting rule from `diagrams.md`. This ensures all analyst subagents that preload this skill receive the guidance when generating Mermaid diagrams.

## Patches

### `.workaholic/specs/model.md`

```diff
--- a/.workaholic/specs/model.md
+++ b/.workaholic/specs/model.md
@@ -59,9 +59,9 @@ flowchart TD
     Command -->|produces| Spec
     Command -->|produces| Story
     Ticket -->|archived to| Archive[archive/branch/]
-    Ticket -->|implemented by| Drive[/drive]
-    Spec -->|generated by| Scan[/scan]
-    Story -->|generated by| Report[/report]
+    Ticket -->|implemented by| Drive["/drive"]
+    Spec -->|generated by| Scan["/scan"]
+    Story -->|generated by| Report["/report"]
 ```
```

### `.workaholic/specs/model_ja.md`

```diff
--- a/.workaholic/specs/model_ja.md
+++ b/.workaholic/specs/model_ja.md
@@ -59,9 +59,9 @@ flowchart TD
     Command -->|produces| Spec
     Command -->|produces| Story
     Ticket -->|archived to| Archive[archive/branch/]
-    Ticket -->|implemented by| Drive[/drive]
-    Spec -->|generated by| Scan[/scan]
-    Story -->|generated by| Report[/report]
+    Ticket -->|implemented by| Drive["/drive"]
+    Spec -->|generated by| Scan["/scan"]
+    Story -->|generated by| Report["/report"]
 ```
```

### `.workaholic/specs/component.md`

```diff
--- a/.workaholic/specs/component.md
+++ b/.workaholic/specs/component.md
@@ -101,10 +101,10 @@ flowchart TD
 ```mermaid
 flowchart TD
     subgraph Commands
-        ticket[/ticket]
-        drive[/drive]
-        scan[/scan]
-        report[/report]
+        ticket["/ticket"]
+        drive["/drive"]
+        scan["/scan"]
+        report["/report"]
     end
```

### `.workaholic/specs/component_ja.md`

```diff
--- a/.workaholic/specs/component_ja.md
+++ b/.workaholic/specs/component_ja.md
@@ -68,10 +68,10 @@ flowchart TD
 ```mermaid
 flowchart TD
     subgraph Commands
-        ticket[/ticket]
-        drive[/drive]
-        scan[/scan]
-        report[/report]
+        ticket["/ticket"]
+        drive["/drive"]
+        scan["/scan"]
+        report["/report"]
     end
```

### `.workaholic/specs/data_ja.md`

```diff
--- a/.workaholic/specs/data_ja.md
+++ b/.workaholic/specs/data_ja.md
@@ -73,7 +73,7 @@ flowchart LR
 ```mermaid
 flowchart LR
     Create[todo/ で作成] --> Implement[/drive で実装]
-    Implement --> Approve{承認?}
+    Create["todo/ で作成"] --> Implement["/drive で実装"]
+    Implement --> Approve{"承認?"}
```

> **Note**: This patch for data_ja.md is speculative - verify the exact line content and surrounding context before applying. The Japanese text with special characters should all be quoted for safety.

### `plugins/core/skills/analyze-viewpoint/SKILL.md`

```diff
--- a/plugins/core/skills/analyze-viewpoint/SKILL.md
+++ b/plugins/core/skills/analyze-viewpoint/SKILL.md
@@ -65,6 +65,16 @@

 <Mermaid diagram of the appropriate type>

+## Mermaid Node Label Quoting (REQUIRED)
+
+When generating Mermaid diagrams, **MUST quote labels** containing special characters (`/`, `{`, `}`, `[`, `]`):
+
+- `A[/command]` -- WRONG, causes GitHub lexical error
+- `A["/command"]` -- CORRECT
+- `B{Decision?}` -- acceptable (no special chars inside braces)
+- `C["path/to/file"]` -- CORRECT for paths with slashes
+
+This is especially common for slash-command labels like `/ticket`, `/drive`, `/scan`, `/report`.
+
 ## Assumptions
```

## Considerations

- **Recurring pattern**: This is the fourth time this exact bug has been fixed for different files. The prevention fix in `analyze-viewpoint/SKILL.md` breaks the cycle by embedding the rule where analysts actually read it (`plugins/core/skills/analyze-viewpoint/SKILL.md`)
- **data_ja.md has additional quoting opportunities**: The Japanese text labels in `data_ja.md` (e.g., `Create[todo/ で作成]`, `Approve{承認?}`) could benefit from quoting even though only the `/drive` label is strictly broken. Consider quoting all labels with special characters for consistency (`.workaholic/specs/data_ja.md` lines 75-82)
- **data.md English counterpart**: Check if `.workaholic/specs/data.md` has the same diagram pattern and whether it also needs quoting (`.workaholic/specs/data.md`)
- **Other spec files**: A full audit of all `.workaholic/specs/*.md` files for additional unquoted labels would be prudent during implementation (`plugins/core/rules/diagrams.md` lines 46-48)
- **Rule file already correct**: The `diagrams.md` rule (lines 35-48) is already well-documented; the gap is in skill propagation, not rule definition (`plugins/core/rules/diagrams.md`)

## Final Report

All 12 unquoted Mermaid node labels across 5 spec files were quoted. Additionally, quoting was applied to adjacent labels with special characters in `data_ja.md` (`Create["todo/ で作成"]`, `Approve{"承認?"}`) for consistency. The `data.md` English counterpart was checked and has no Mermaid diagram requiring fixes. A "Mermaid Node Label Quoting (REQUIRED)" section was added to `plugins/core/skills/analyze-viewpoint/SKILL.md` to prevent recurrence by analyst subagents.
