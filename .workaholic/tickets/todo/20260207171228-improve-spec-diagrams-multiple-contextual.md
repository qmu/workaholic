---
created_at: 2026-02-07T17:12:28+09:00
author: a@qmu.jp
type: enhancement
layer: [Config]
effort:
commit_hash:
category:
---

# Replace Single Generic "Diagram" Section with Multiple Contextual Diagrams in Specs

## Overview

All 8 viewpoint spec documents generated by `/scan` contain exactly one diagram, placed in a dedicated section titled "Diagram" (e.g., "## 6. Diagram", "## 7. Diagram"). This pattern has two problems: the title "Diagram" conveys no meaning about what the diagram illustrates, and limiting each spec to a single diagram forces complex viewpoints to compress multiple concepts into one visual. This ticket changes the spec generation framework to produce multiple diagrams placed inline within their relevant sections, each with a descriptive title that explains what it shows.

## Key Files

- `plugins/core/skills/analyze-viewpoint/SKILL.md` - The output template (lines 37-71) defines a single `## Diagram` section that all 8 analysts follow. This is the primary source of the pattern.
- `plugins/core/agents/stakeholder-analyst.md` - Viewpoint definition specifies a single `flowchart` diagram type (line 20) and step 4 says "Include a Mermaid `flowchart` diagram" (line 38).
- `plugins/core/agents/model-analyst.md` - Viewpoint definition specifies a single `classDiagram` diagram type (line 20) and step 4 says "Include a Mermaid `classDiagram` diagram" (line 38).
- `plugins/core/agents/usecase-analyst.md` - Viewpoint definition specifies a single `sequenceDiagram` diagram type (line 20) and step 4 says "Include a Mermaid `sequenceDiagram` diagram" (line 38).
- `plugins/core/agents/infrastructure-analyst.md` - Viewpoint definition specifies a single `flowchart` diagram type (line 20) and step 4 says "Include a Mermaid `flowchart` diagram" (line 38).
- `plugins/core/agents/application-analyst.md` - Viewpoint definition specifies a single `sequenceDiagram` diagram type (line 20) and step 4 says "Include a Mermaid `sequenceDiagram` diagram" (line 38).
- `plugins/core/agents/component-analyst.md` - Viewpoint definition specifies a single `flowchart` diagram type (line 20) and step 4 says "Include a Mermaid `flowchart` diagram" (line 38).
- `plugins/core/agents/data-analyst.md` - Viewpoint definition specifies a single `erDiagram` diagram type (line 20) and step 4 says "Include a Mermaid `erDiagram` diagram" (line 38).
- `plugins/core/agents/feature-analyst.md` - Viewpoint definition specifies a single `flowchart` diagram type (line 20) and step 4 says "Include a Mermaid `flowchart` diagram" (line 38).
- `plugins/core/skills/write-spec/SKILL.md` - Content style section (line 107) mentions "Use Mermaid charts for diagrams" but gives no guidance on quantity or placement.

## Related History

The spec diagram system evolved from an initial enforcement of Mermaid as the standard, through the viewpoint-based architecture migration, with recurring fixes for Mermaid formatting issues. The single-diagram pattern was introduced in the viewpoint architecture ticket and has been unchanged since.

Past tickets that touched similar areas:

- [20260207023921-viewpoint-based-spec-architecture.md](.workaholic/tickets/archive/drive-20260205-195920/20260207023921-viewpoint-based-spec-architecture.md) - Introduced the 8-viewpoint architecture with single Mermaid diagram per viewpoint (origin of the pattern)
- [20260207112021-fix-mermaid-unquoted-labels-in-specs.md](.workaholic/tickets/archive/drive-20260205-195920/20260207112021-fix-mermaid-unquoted-labels-in-specs.md) - Fixed Mermaid quoting in spec diagrams and added quoting section to analyze-viewpoint skill
- [20260124120158-enforce-mermaid-for-diagrams.md](.workaholic/tickets/archive/feat-20260124-105903/20260124120158-enforce-mermaid-for-diagrams.md) - Established Mermaid as the standard for all diagrams
- [20260207035026-flatten-scan-writer-nesting.md](.workaholic/tickets/archive/drive-20260205-195920/20260207035026-flatten-scan-writer-nesting.md) - Flattened scanner agent nesting, moved viewpoint definitions into individual analyst agents

## Implementation Steps

1. **Update the analyze-viewpoint output template** - In `plugins/core/skills/analyze-viewpoint/SKILL.md`, replace the single `## Diagram` section in the output template (lines 63-66) with guidance for embedding multiple diagrams inline within content sections. The template should instruct analysts to:
   - Place diagrams immediately after the prose they illustrate, within the relevant content section
   - Give each diagram a descriptive subsection heading (e.g., "### Ticket Lifecycle Flow" rather than "## Diagram")
   - Use at least 2 diagrams per spec, using different Mermaid types where appropriate (flowchart, sequenceDiagram, classDiagram, erDiagram)
   - Never title a diagram section simply "Diagram"

2. **Update the stakeholder-analyst viewpoint definition** - In `plugins/core/agents/stakeholder-analyst.md`, change the `**Mermaid diagram**` field from a single type to suggested diagram types (plural). Update step 4 to say "Include Mermaid diagrams within content sections" instead of "Include a Mermaid `flowchart` diagram". Suggest diagram ideas: stakeholder relationship flowchart, command interaction sequence diagram.

3. **Update the model-analyst viewpoint definition** - In `plugins/core/agents/model-analyst.md`, change to suggested diagram types. Suggest: domain entity class diagram, entity relationship flowchart, ticket lifecycle state diagram.

4. **Update the usecase-analyst viewpoint definition** - In `plugins/core/agents/usecase-analyst.md`, change to suggested diagram types. Suggest: per-command sequence diagrams, workflow overview flowchart.

5. **Update the infrastructure-analyst viewpoint definition** - In `plugins/core/agents/infrastructure-analyst.md`, change to suggested diagram types. Suggest: file system layout flowchart, CI/CD pipeline flowchart, dependency relationship diagram.

6. **Update the application-analyst viewpoint definition** - In `plugins/core/agents/application-analyst.md`, change to suggested diagram types. Suggest: per-command orchestration sequence diagrams, data flow flowchart, concurrency pattern diagram.

7. **Update the component-analyst viewpoint definition** - In `plugins/core/agents/component-analyst.md`, change to suggested diagram types. Suggest: component hierarchy flowchart, nesting policy class diagram, agent grouping subgraph.

8. **Update the data-analyst viewpoint definition** - In `plugins/core/agents/data-analyst.md`, change to suggested diagram types. Suggest: frontmatter schema ER diagram, data lifecycle flowchart, naming convention table (as diagram if complex).

9. **Update the feature-analyst viewpoint definition** - In `plugins/core/agents/feature-analyst.md`, change to suggested diagram types. Suggest: capability matrix flowchart, feature dependency graph, cross-cutting concerns relationship diagram.

10. **Update write-spec content style** - In `plugins/core/skills/write-spec/SKILL.md`, update the content style section (line 107) to reinforce the inline diagram placement policy. Add guidance that diagrams should be embedded within the sections they illustrate, not collected into a separate "Diagram" section.

## Patches

### `plugins/core/skills/analyze-viewpoint/SKILL.md`

```diff
--- a/plugins/core/skills/analyze-viewpoint/SKILL.md
+++ b/plugins/core/skills/analyze-viewpoint/SKILL.md
@@ -60,9 +60,7 @@ Each viewpoint produces a spec document following this structure:

 ...

-## Diagram
-
-<Mermaid diagram of the appropriate type>
+<!-- Diagrams go inline within content sections above, not in a separate section -->

 ## Assumptions

```

### `plugins/core/agents/stakeholder-analyst.md`

```diff
--- a/plugins/core/agents/stakeholder-analyst.md
+++ b/plugins/core/agents/stakeholder-analyst.md
@@ -17,7 +17,7 @@
 - **Slug**: stakeholder
 - **Description**: Who uses the system, their goals, and interaction patterns
 - **Analysis prompts**: Who are the primary users? What goals does each user type have? How do stakeholders interact with the system? What are the onboarding paths?
-- **Mermaid diagram**: `flowchart` showing stakeholder relationships and interaction flows
+- **Mermaid diagrams**: Embed within content sections. Suggested: `flowchart` for stakeholder relationships, `sequenceDiagram` for command interaction patterns
 - **Output sections**: Stakeholder Map, User Goals, Interaction Patterns, Onboarding Paths

 ## Instructions
@@ -35,7 +35,7 @@

 3. **Analyze Codebase**: Use the analysis prompts above. Read relevant source files to understand the system deeply.

-4. **Write English Spec**: Write `.workaholic/specs/stakeholder.md` following the preloaded analyze-viewpoint and write-spec skills. Include a Mermaid `flowchart` diagram and an Assumptions section with `[Explicit]`/`[Inferred]` prefixes.
+4. **Write English Spec**: Write `.workaholic/specs/stakeholder.md` following the preloaded analyze-viewpoint and write-spec skills. Include multiple Mermaid diagrams within content sections and an Assumptions section with `[Explicit]`/`[Inferred]` prefixes.

 5. **Write Japanese Translation**: Write `.workaholic/specs/stakeholder_ja.md` following the preloaded translate skill.
```

### `plugins/core/agents/application-analyst.md`

> **Note**: This patch shows the pattern; apply the same structure to all 8 analyst agents.

```diff
--- a/plugins/core/agents/application-analyst.md
+++ b/plugins/core/agents/application-analyst.md
@@ -17,7 +17,7 @@
 - **Slug**: application
 - **Description**: Runtime behavior, agent orchestration, and data flow
 - **Analysis prompts**: How do agents orchestrate at runtime? What is the data flow? What are the execution lifecycles? How do parallel and sequential operations interact?
-- **Mermaid diagram**: `sequenceDiagram` showing runtime orchestration and data flow
+- **Mermaid diagrams**: Embed within content sections. Suggested: `sequenceDiagram` for per-command orchestration, `flowchart` for data flow paths, `flowchart` for concurrency patterns
 - **Output sections**: Orchestration Model, Data Flow, Execution Lifecycle, Concurrency Patterns

 ## Instructions
@@ -35,7 +35,7 @@

 3. **Analyze Codebase**: Use the analysis prompts above. Read relevant source files to understand the system deeply.

-4. **Write English Spec**: Write `.workaholic/specs/application.md` following the preloaded analyze-viewpoint and write-spec skills. Include a Mermaid `sequenceDiagram` diagram and an Assumptions section with `[Explicit]`/`[Inferred]` prefixes.
+4. **Write English Spec**: Write `.workaholic/specs/application.md` following the preloaded analyze-viewpoint and write-spec skills. Include multiple Mermaid diagrams within content sections and an Assumptions section with `[Explicit]`/`[Inferred]` prefixes.

 5. **Write Japanese Translation**: Write `.workaholic/specs/application_ja.md` following the preloaded translate skill.
```

## Considerations

- The existing 8 spec files will not be updated by this ticket. They will be regenerated with multiple diagrams on the next `/scan` run. Any in-flight work on spec content (e.g., the merge-legacy-specs ticket) should be completed first to avoid rework. (`.workaholic/specs/`)
- The `model.md` spec currently embeds its diagram in a "## 3. Relationships" section rather than a separate "## Diagram" section, which is actually closer to the desired behavior. The other 7 specs all use a dedicated "Diagram" section. (`.workaholic/specs/model.md` line 51)
- The `usecase.md` spec also embeds its diagram in "## 3. Workflow Sequence" rather than a separate section. Two of the eight specs already follow the inline pattern, which validates the approach. (`.workaholic/specs/usecase.md` line 59)
- The Mermaid node label quoting section in `analyze-viewpoint/SKILL.md` (lines 73-82) should remain unchanged. It applies regardless of whether diagrams are in a single section or inline. (`plugins/core/skills/analyze-viewpoint/SKILL.md` lines 73-82)
- Increasing the number of diagrams per spec increases output token count per analyst agent. Since all 8 analysts run in parallel on sonnet, this should not meaningfully impact total scan time, but may increase cost per scan. (`plugins/core/agents/scanner.md`)
- The `diagrams.md` rule (line 8: "Use Mermaid, not ASCII art") already applies to all markdown files and does not constrain diagram quantity or placement, so no changes are needed there. (`plugins/core/rules/diagrams.md`)
- The `feature.md` and `data.md` specs already embed their diagrams with contextual section titles ("## 4. Capability Matrix" and "## 6. Data Lifecycle" respectively), further confirming that the inline approach is natural and several analysts already gravitate toward it when the content warrants it. (`.workaholic/specs/feature.md` line 92, `.workaholic/specs/data.md` line 120)
